<!DOCTYPE html>
<html>
<head>
  <title>Cash Out Voting Rights</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; text-align: center; }
    h1 { font-size: 24px; }
    .info { margin: 10px 0; }
    .input-group { margin: 15px 0; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { margin: 10px; padding: 10px 20px; cursor: pointer; font-size: 16px; }
    .status { color: green; }
    .error { color: red; }
    #shareOptions { display: none; margin-top: 10px; }
    #shareOptions a, #shareOptions button { margin: 10px; }
  </style>
</head>
<body>
  <h1>Cash out voting rights</h1>
  <p id="status"></p>
  <div id="info" style="display: none;">
    <div class="info">Total Voting Rights: <span id="votingRights"></span></div>
    <div class="info">Value per Voting Right: <span id="valuePerRight"></span></div>
    <div class="info">Total Assets on Ledger: <span id="totalAssets"></span></div>
    <div class="input-group">
      <label for="amount">Voting Rights to Cash Out</label>
      <input type="number" id="amount" placeholder="Enter number of voting rights" min="0">
    </div>
    <div class="input-group">
      <label for="price">Asking Price (Total)</label>
      <input type="number" id="price" placeholder="Enter asking price" min="0" step="0.01">
    </div>
    <button onclick="submitRequest()">Submit Request</button>
    <div id="shareOptions">
      <a id="telegramShare" href="#" target="_blank">Share via Telegram</a>
      <button onclick="copyToClipboard()">Copy for WhatsApp</button>
    </div>
  </div>

  <script>
    // Utility function for Base64 conversion
    function arrayBufferToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    // Check for public key and fetch data on page load
    window.onload = async function() {
      const publicKey = localStorage.getItem('publicKey');
      if (!publicKey) {
        document.getElementById('status').textContent = 'No digital signature found. Redirecting to create one...';
        document.getElementById('status').className = 'error';
        setTimeout(() => {
          window.location.href = './create_signature.html';
        }, 2000);
        return;
      }

      try {
        const response = await fetch(
          `https://script.google.com/macros/s/AKfycbzB_FUyrMJ6oi9TERS-Kw-XjRm3mTFAO2V5t5_fL7CkK9DK-aP5A3ckxVqJ3kQGrqfH/exec?signature=${encodeURIComponent(publicKey)}`
        );
        const data = await response.json();

        if (data.error) {
          document.getElementById('status').textContent = 'Error: ' + data.error;
          document.getElementById('status').className = 'error';
          return;
        }

        document.getElementById('votingRights').textContent = data.voting_rights;
        document.getElementById('valuePerRight').textContent = data.asset_per_circulated_voting_right.toFixed(2);
        document.getElementById('totalAssets').textContent = data.total_assets;
        document.getElementById('info').style.display = 'block';
        document.getElementById('status').textContent = 'Data loaded successfully.';
        document.getElementById('status').className = 'status';
      } catch (error) {
        document.getElementById('status').textContent = 'Error fetching data: ' + error;
        document.getElementById('status').className = 'error';
      }
    };

    // Submit and share request
    async function submitRequest() {
      const amount = document.getElementById('amount').value;
      const price = document.getElementById('price').value;
      const publicKey = localStorage.getItem('publicKey');
      const privateKey = localStorage.getItem('privateKey');

      if (!amount || !price || !publicKey || !privateKey) {
        document.getElementById('status').textContent = 'Please provide voting rights amount, asking price, and ensure keys are available.';
        document.getElementById('status').className = 'error';
        return;
      }

      try {
        // Generate request text
        const requestText = `[VOTING RIGHTS WITHDRAWAL REQUEST]\namount to withdraw: ${amount}\nasking price: ${price}\n--------`;
        
        // Sign the request text
        const privateKeyObj = await window.crypto.subtle.importKey(
          "pkcs8",
          base64ToArrayBuffer(privateKey),
          { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
          false,
          ["sign"]
        );

        const encoder = new TextEncoder();
        const data = encoder.encode(requestText);
        const signature = await window.crypto.subtle.sign(
          "RSASSA-PKCS1-v1_5",
          privateKeyObj,
          data
        );
        const requestHash = arrayBufferToBase64(signature);

        // Full share text
        const shareText = `${requestText}\nDigital Signature: ${publicKey}\nRequest Hash: ${requestHash}`;

        // Show share options
        const shareOptions = document.getElementById('shareOptions');
        shareOptions.style.display = 'block';

        // Telegram share link
        const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(shareText)}`;
        document.getElementById('telegramShare').href = telegramUrl;

        // Web Share API (if available)
        if (navigator.share) {
          navigator.share({
            text: shareText
          }).catch(error => {
            console.error('Web Share error:', error);
          });
        }

        document.getElementById('status').textContent = 'Request generated! Share it using the options below.';
        document.getElementById('status').className = 'status';
      } catch (error) {
        document.getElementById('status').textContent = 'Error generating request: ' + error;
        document.getElementById('status').className = 'error';
      }
    }

    // Utility function to convert Base64 to ArrayBuffer
    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    // Copy share text for WhatsApp
    function copyToClipboard() {
      const amount = document.getElementById('amount').value;
      const price = document.getElementById('price').value;
      const publicKey = localStorage.getItem('publicKey');
      const requestText = `[VOTING RIGHTS WITHDRAWAL REQUEST]\namount to withdraw: ${amount}\nasking price: ${price}\n--------`;
      
      // Re-sign to ensure consistency (in case user modifies inputs after submitting)
      window.crypto.subtle.importKey(
        "pkcs8",
        base64ToArrayBuffer(localStorage.getItem('privateKey')),
        { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
        false,
        ["sign"]
      ).then(privateKeyObj => {
        const encoder = new TextEncoder();
        const data = encoder.encode(requestText);
        window.crypto.subtle.sign(
          "RSASSA-PKCS1-v1_5",
          privateKeyObj,
          data
        ).then(signature => {
          const requestHash = arrayBufferToBase64(signature);
          const shareText = `${requestText}\nDigital Signature: ${publicKey}\nRequest Hash: ${requestHash}`;
          
          navigator.clipboard.writeText(shareText).then(() => {
            document.getElementById('status').textContent = 'Request copied to clipboard! Paste it into WhatsApp.';
            document.getElementById('status').className = 'status';
          }).catch(error => {
            document.getElementById('status').textContent = 'Error copying to clipboard: ' + error;
            document.getElementById('status').className = 'error';
          });
        });
      }).catch(error => {
        document.getElementById('status').textContent = 'Error signing request: ' + error;
        document.getElementById('status').className = 'error';
      });
    }
  </script>
</body>
</html>