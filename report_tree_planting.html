<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="Report a tree planting event with a photo and location">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Tree Planting</title>

  <!-- Open Graph tags for WhatsApp and social media previews -->
  <meta property="og:title" content="Report Tree Planting">
  <meta property="og:description" content="Report a tree planting event with a photo and location">
  <meta property="og:image" content="https://github.com/TrueSightDAO/.github/blob/main/assets/20240612_truesight_dao_logo_square.png?raw=true">
  <meta property="og:url" content="https://truesightdao.github.io/dapp/">
  <meta property="og:type" content="website">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://github.com/TrueSightDAO/.github/blob/main/assets/20240612_truesight_dao_logo_square.png?raw=true">

  <script src="./menu.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 1rem;
      padding: 1rem;
      min-height: 100vh;
      box-sizing: border-box;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background-color: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 1.8rem;
      color: #333;
      margin: 0.5rem 0 1rem;
      text-align: center;
    }
    #description {
      font-style: italic;
      color: #555;
      line-height: 1.5;
      margin: 0.8rem 0;
      font-size: 1rem;
      text-align: center;
    }
    #backLink {
      top: 1rem;
      left: 1rem;
      font-size: 1rem;
      color: #007bff;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      transition: color 0.2s;
    }
    #backLink:hover {
      color: #0056b3;
      text-decoration: underline;
    }
    #backLink::before {
      content: "‚Üê";
      font-size: 1.2rem;
    }
    #status {
      margin: 1rem 0;
      font-weight: bold;
      min-height: 24px;
      font-size: 1rem;
      text-align: center;
    }
    #welcome {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 0.8rem 0;
      text-align: center;
      display: none;
    }
    .status {
      color: #28a745;
    }
    .error {
      color: #dc3545;
    }
    .warning {
      color: #ffc107;
    }
    .info-box {
      margin: 1rem 0;
      background-color: #f8f9fa;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 0.95rem;
    }
    .info {
      font-weight: bold;
      text-align: left;
      font-size: 1rem;
      margin: 0.5rem 0;
    }
    .info-location {
      font-weight: normal;
      margin-left: 1.5rem;
      line-height: 1.4;
    }
    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    button {
      padding: 0.8rem 1.5rem;
      cursor: pointer;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      transition: background-color 0.2s, transform 0.1s;
      margin: 0.5rem 0;
      width: 100%;
      max-width: 300px;
    }
    button:hover {
      background-color: #45a049;
      transform: scale(1.02);
    }
    button:active {
      transform: scale(0.98);
    }
    #action-status {
      margin: 0.5rem 0;
      font-size: 1rem;
      text-align: center;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .loading {
      color: #6c757d;
      font-style: italic;
      animation: pulse 2s infinite ease-in-out;
    }
    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    #cameraPreview {
      width: 100%;
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      margin: 1rem 0;
      display: none;
    }
    label {
      display: block;
      margin: 0.5rem 0 0.2rem;
      font-size: 0.95rem;
      color: #333;
    }
    select, input[type="number"], input[type="text"] {
      margin-bottom: 0.8rem;
      width: 100%;
      padding: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 0.95rem;
    }
    @media (max-width: 600px) {
      body {
        margin: 0.5rem;
        padding: 0.5rem;
      }
      h1 {
        font-size: 1.5rem;
      }
      .container {
        padding: 0.8rem;
      }
      #description {
        font-size: 0.95rem;
      }
      #status {
        font-size: 0.95rem;
      }
      #welcome {
        font-size: 1.1rem;
      }
      .info-box {
        padding: 0.5rem;
        font-size: 0.9rem;
      }
      .info, .info-location {
        font-size: 0.95rem;
        text-align: center;
      }
      button {
        padding: 1rem;
        font-size: 1rem;
      }
      #cameraPreview {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="navDropdown" style="margin:1rem 0; text-align:center;"></div>
  <div id="google_translate_element" style="text-align: right; margin: 1rem;"></div>
  <div class="container">

    <div style="text-align: center;">
      <img id="logo" height="200px" src="https://github.com/TrueSightDAO/.github/blob/main/assets/20240612_truesight_dao_logo_square.png?raw=true" alt="TrueSightDAO Logo"/>
    </div>
    <h1>Report Tree Planting</h1>
    <p id="description">
      Take a photo at the exact location where the tree is planted, ensuring it includes both the planted tree and a clear, legible copy of the receipt for the tree purchase. Select the tree species, enter the cost of the tree and its currency, and click "Submit Report" to share the photo with your location and cost details via WhatsApp to our program administrator at <a href="https://wa.me/14153000019">+1 415 300 0019</a> for reimbursement of planting costs. Register your account at <a href="./create_signature.html">create_signature.html</a> when online.
    </p>
    <div id="welcome" style="display: none;"></div>
    <p id="status" class="fade-in">Setting up your signature...</p>
    <div id="info" style="display: none;">
      <video id="cameraPreview" autoplay playsinline></video>
      <canvas id="captureCanvas" style="display: none;"></canvas>
      <div class="info-box">
        <div class="info">Current Location:</div>
        <div class="info-location" id="location">Waiting for geolocation...</div>
        <label for="treeSpecies">Tree Species Planted:</label>
        <select id="treeSpecies" name="treeSpecies" required>
          <option value="" disabled selected>Select a species</option>
          <option value="Cacao (Native)">Cacao (Native)</option>
          <option value="Brazil Nut (Native)">Brazil Nut (Native)</option>
          <option value="Acai (Native)">Acai (Native)</option>
          <option value="Mahogany (Native)">Mahogany (Native)</option>
          <option value="Jatoba (Native)">Jatoba (Native)</option>
          <option value="Other">Other (specify)</option>
        </select>
        <label for="treeCost">Cost of Tree:</label>
        <input type="number" id="treeCost" name="treeCost" min="0" step="0.01" placeholder="Enter cost (e.g., 10.50)" required>
        <label for="currency">Currency:</label>
        <select id="currency" name="currency" required>
          <option value="" disabled selected>Select currency</option>
          <option value="USD">USD (US Dollar)</option>
          <option value="BRL">BRL (Brazilian Real)</option>
          <option value="EUR">EUR (Euro)</option>
          <option value="Other">Other (specify)</option>
        </select>
        <input type="text" id="otherCurrency" name="otherCurrency" placeholder="Specify currency" style="display: none;" maxlength="10">
      </div>
      <div class="button-container">
        <button id="submitButton" onclick="submitReport()">Submit Report</button>
      </div>
      <p id="action-status"></p>
    </div>
  </div>

  <script>
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbygmwRbyqse-dpCYMco0rb93NSgg-Jc1QIw7kUiBM7CZK6jnWnMB5DEjdoX_eCsvVs7/exec';
    let latitude = null;
    let longitude = null;
    let imageFile = null;
    let stream = null;
    let newKeysGenerated = false;

    function arrayBufferToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }

    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function isOnline() {
      return navigator.onLine;
    }

    async function generateKeyPair() {
      const keyPair = await window.crypto.subtle.generateKey(
        {
          name: "RSASSA-PKCS1-v1_5",
          modulusLength: 2048,
          publicExponent: new Uint8Array([1, 0, 1]),
          hash: "SHA-256"
        },
        true,
        ["sign", "verify"]
      );

      const publicKey = await window.crypto.subtle.exportKey("spki", keyPair.publicKey);
      const privateKey = await window.crypto.subtle.exportKey("pkcs8", keyPair.privateKey);

      const publicKeyBase64 = arrayBufferToBase64(publicKey);
      const privateKeyBase64 = arrayBufferToBase64(privateKey);

      localStorage.setItem('publicKey', publicKeyBase64);
      localStorage.setItem('privateKey', privateKeyBase64);
      newKeysGenerated = true;
    }

    function startCamera() {
      const video = document.getElementById('cameraPreview');
      const submitButton = document.getElementById('submitButton');
      const actionStatus = document.getElementById('action-status');

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        actionStatus.textContent = 'Camera not supported on this device.';
        actionStatus.className = 'error';
        submitButton.style.display = 'none';
        return;
      }

      const constraints = {
        video: isMobileDevice()
          ? {
              facingMode: { ideal: 'environment' },
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          : true
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(function(s) {
          stream = s;
          video.srcObject = stream;
          video.style.display = 'block';
          submitButton.style.display = 'block';
          actionStatus.textContent = 'Camera started. Point at the tree and click "Submit Report".';
          actionStatus.className = 'status';
        })
        .catch(function(error) {
          actionStatus.textContent = 'Error accessing camera: ' + error.message;
          actionStatus.className = 'error';
          submitButton.style.display = 'none';
        });
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation not supported on this device.'));
        }
        navigator.geolocation.getCurrentPosition(
          position => {
            latitude = position.coords.latitude.toFixed(6);
            longitude = position.coords.longitude.toFixed(6);
            resolve({ latitude, longitude });
          },
          error => reject(new Error('Error getting location: ' + error.message)),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });
    }

    document.getElementById('currency').addEventListener('change', function() {
      const otherCurrencyInput = document.getElementById('otherCurrency');
      if (this.value === 'Other') {
        otherCurrencyInput.style.display = 'block';
        otherCurrencyInput.setAttribute('required', 'true');
      } else {
        otherCurrencyInput.style.display = 'none';
        otherCurrencyInput.removeAttribute('required');
      }
    });

    async function submitReport() {
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('captureCanvas');
      const actionStatus = document.getElementById('action-status');
      const publicKey = localStorage.getItem('publicKey');
      const privateKey = localStorage.getItem('privateKey');
      const treeSpecies = document.getElementById('treeSpecies').value;
      const treeCost = document.getElementById('treeCost').value;
      const currency = document.getElementById('currency').value;
      const otherCurrency = document.getElementById('otherCurrency').value;
      const finalCurrency = currency === 'Other' ? (otherCurrency || 'Unknown') : currency;

      if (!stream) {
        actionStatus.textContent = 'Camera not started. Please ensure camera access is allowed.';
        actionStatus.className = 'error';
        return;
      }

      if (!latitude || !longitude) {
        actionStatus.textContent = 'Location not available. Please allow location access and try again.';
        actionStatus.className = 'error';
        return;
      }

      if (!publicKey || !privateKey) {
        actionStatus.textContent = 'Signature setup failed. Please try again.';
        actionStatus.className = 'error';
        return;
      }

      if (!treeSpecies) {
        actionStatus.textContent = 'Please select a tree species.';
        actionStatus.className = 'error';
        return;
      }

      if (!treeCost || treeCost <= 0) {
        actionStatus.textContent = 'Please enter a valid tree cost greater than 0.';
        actionStatus.className = 'error';
        return;
      }

      if (!currency || (currency === 'Other' && !otherCurrency)) {
        actionStatus.textContent = 'Please select a currency or specify one for "Other".';
        actionStatus.className = 'error';
        return;
      }

      try {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
        imageFile = new File([blob], 'tree_photo.jpg', { type: 'image/jpeg' });

        const plantingTime = new Date().toISOString();

        const now = new Date();
        const pad = (n) => n.toString().padStart(2, '0');
        const yyyymmddhhmmss = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;

        const safePublicKey = publicKey.replace(/[^a-zA-Z0-9]/g, '').slice(0, 20);

        const photoCaptureDestinationURL = `https://github.com/TrueSightDAO/sunmint/tree/main/images/${yyyymmddhhmmss}_${safePublicKey}.jpg`;

        const requestText = `[TREE PLANTING EVENT]\n- Latitude: ${latitude}\n- Longitude: ${longitude}\n- Species: ${treeSpecies}\n- Cost: ${treeCost} ${finalCurrency}\n- Planting Time: ${plantingTime}\n- Photo URL: ${photoCaptureDestinationURL}\n--------`;

        const privateKeyObj = await window.crypto.subtle.importKey(
          "pkcs8",
          base64ToArrayBuffer(privateKey),
          { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
          false,
          ["sign"]
        );

        const encoder = new TextEncoder();
        const signature = await window.crypto.subtle.sign(
          "RSASSA-PKCS1-v1_5",
          privateKeyObj,
          encoder.encode(requestText)
        );
        const requestHash = arrayBufferToBase64(signature);
        const shareText = `${requestText}

My Digital Signature: ${publicKey}

Request Transaction ID: ${requestHash}

This submission was generated using ${window.location.href}

Verify submission here: https://dapp.truesight.me/verify_request.html

<a href="./create_signature.html">Register your account</a> when online.`;

        if (isMobileDevice() && navigator.share) {
          await navigator.share({
            text: shareText,
            files: [imageFile]
          });
          actionStatus.innerHTML = 'Report shared successfully via WhatsApp!' + (newKeysGenerated ? ' <a href="./create_signature.html">Register your account</a>.' : '');
          actionStatus.className = 'status';
        } else {
          await navigator.clipboard.writeText(shareText);
          actionStatus.innerHTML = 'Report copied to clipboard! Share it with the photo via WhatsApp.' + (newKeysGenerated ? ' <a href="./create_signature.html">Register your account</a>.' : '');
          actionStatus.className = 'status';
        }

        stream.getTracks().forEach(track => track.stop());
        stream = null;
        video.style.display = 'none';

        if (newKeysGenerated && isOnline()) {
          actionStatus.innerHTML += ' Redirecting to register your account...';
          setTimeout(() => {
            window.location.href = './create_signature.html';
          }, 3000);
        }
      } catch (error) {
        actionStatus.textContent = 'Error generating report: ' + error.message;
        actionStatus.className = 'error';
      }
    }

    window.onload = async function () {
      const statusElement = document.getElementById('status');
      statusElement.textContent = 'Setting up your signature...';
      statusElement.className = 'loading fade-in';

      let publicKey = localStorage.getItem('publicKey');
      let privateKey = localStorage.getItem('privateKey');

      if (!publicKey || !privateKey) {
        try {
          await generateKeyPair();
          publicKey = localStorage.getItem('publicKey');
          privateKey = localStorage.getItem('privateKey');
          statusElement.textContent = 'Signature created successfully';
          statusElement.className = 'status fade-in';
        } catch (error) {
          statusElement.textContent = 'Error creating signature: ' + error.message;
          statusElement.className = 'error fade-in';
          return;
        }
      }

      if (!isOnline()) {
        statusElement.innerHTML = 'Offline mode: <a href="./create_signature.html">Register your account</a> when online.';
        statusElement.className = 'warning fade-in';
        document.getElementById('info').style.display = 'block';
        document.getElementById('welcome').textContent = 'Welcome! (Offline Mode)';
        document.getElementById('welcome').style.display = 'block';

        try {
          const location = await getLocation();
          document.getElementById('location').innerHTML = `Latitude: ${location.latitude},<br>Longitude: ${location.longitude}`;
          startCamera();
        } catch (error) {
          document.getElementById('location').textContent = error.message;
          statusElement.textContent = 'Location access denied. Please allow location permissions.';
          statusElement.className = 'error fade-in';
          document.getElementById('submitButton').style.display = 'none';
        }
        return;
      }

      try {
        const timestamp = new Date().toISOString();
        const response = await fetch(`${API_ENDPOINT}?signature=${encodeURIComponent(publicKey)}&timestamp=${encodeURIComponent(timestamp)}`);
        const data = await response.json();

        if (data.error) {
          statusElement.innerHTML = 'Account not registered. <a href="./create_signature.html">Register your account</a>.';
          statusElement.className = 'warning fade-in';
        } else {
          statusElement.textContent = 'Signature verified successfully';
          statusElement.className = 'status fade-in';
          document.getElementById('welcome').textContent = `Welcome back, ${data.contributor_name}!`;
        }

        document.getElementById('info').style.display = 'block';
        document.getElementById('welcome').style.display = 'block';

        try {
          const location = await getLocation();
          document.getElementById('location').innerHTML = `Latitude: ${location.latitude},<br>Longitude: ${location.longitude}`;
          startCamera();
        } catch (error) {
          document.getElementById('location').textContent = error.message;
          statusElement.textContent = 'Location access denied. Please allow location permissions.';
          statusElement.className = 'error fade-in';
          document.getElementById('submitButton').style.display = 'none';
        }
      } catch (error) {
        statusElement.innerHTML = 'Offline mode: <a href="./create_signature.html">Register your account</a> when online.';
        statusElement.className = 'warning fade-in';
        document.getElementById('info').style.display = 'block';
        document.getElementById('welcome').textContent = 'Welcome! (Offline Mode)';
        document.getElementById('welcome').style.display = 'block';

        try {
          const location = await getLocation();
          document.getElementById('location').innerHTML = `Latitude: ${location.latitude},<br>Longitude: ${location.longitude}`;
          startCamera();
        } catch (error) {
          document.getElementById('location').textContent = error.message;
          statusElement.textContent = 'Location access denied. Please allow location permissions.';
          statusElement.className = 'error fade-in';
          document.getElementById('submitButton').style.display = 'none';
        }
      }
    };
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js', { scope: './' })
        .then(reg => console.log('Service Worker registered with scope:', reg.scope))
        .catch(err => console.warn('Service Worker registration failed:', err));
    }
  </script>

  <script>
    (function() {
      const div = document.createElement('div');
      div.style.textAlign = 'center';
      div.style.marginTop = '1rem';
      const url = new URL(window.location.href);
      url.searchParams.set('reload', 'true');
      const a = document.createElement('a');
      a.href = url.toString();
      a.textContent = 'Reload Latest Version';
      a.style.fontSize = '0.8rem';
      a.style.color = '#007bff';
      a.style.textDecoration = 'none';
      div.appendChild(a);
      document.body.appendChild(div);
    })();
  </script>

  <script>
    (function() {
      const div = document.createElement('div');
      div.style.textAlign = 'center';
      div.style.marginTop = '1rem';
      const a = document.createElement('a');
      a.href = 'https://github.com/TrueSightDAO/dapp/blob/main/report_tree_planting.html';
      a.textContent = 'View Source Code';
      a.style.fontSize = '0.8rem';
      a.style.color = '#007bff';
      a.style.textDecoration = 'none';
      div.appendChild(a);
      document.body.appendChild(div);
    })();
  </script>
  <script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    includedLanguages: 'en,pt',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
  }, 'google_translate_element');

  const userLanguage = navigator.language || navigator.userLanguage || 'en';
  let targetLanguage = 'en';

  if (userLanguage.toLowerCase().startsWith('pt')) {
    targetLanguage = 'pt';
  } else {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          const isInBrazil = latitude >= -33.75 && latitude <= 5.27 && longitude >= -73.99 && longitude <= -34.79;
          if (isInBrazil) {
            targetLanguage = 'pt';
          }
          setLanguage(targetLanguage);
        },
        error => {
          console.warn('Geolocation error:', error.message);
          setLanguage(targetLanguage);
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    } else {
      setLanguage(targetLanguage);
    }
    return;
  }

  setLanguage(targetLanguage);
}

function setLanguage(language) {
  const savedLanguage = localStorage.getItem('selectedLanguage');
  const finalLanguage = savedLanguage && ['en', 'pt'].includes(savedLanguage) ? savedLanguage : language;

  console.log('Selected language:', finalLanguage);

  setTimeout(() => {
    const select = document.querySelector('.goog-te-combo');
    if (select) {
      select.value = finalLanguage;
      select.dispatchEvent(new Event('change'));
    }
  }, 1000);
}

function saveLanguageSelection() {
  const select = document.querySelector('.goog-te-combo');
  if (select) {
    select.addEventListener('change', () => {
      const selectedLanguage = select.value;
      if (['en', 'pt'].includes(selectedLanguage)) {
        localStorage.setItem('selectedLanguage', selectedLanguage);
        document.cookie = `googtrans=/en/${selectedLanguage}; path=/`;
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(saveLanguageSelection, 1500);
});
</script>
  <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>
</html>